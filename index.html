<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>AdTargetAI - AI Marketing Campaign Generator</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
    * { font-family: 'Inter', sans-serif; }

      .gradient-bg {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      }

      .glass-effect {
        background: rgba(255, 255, 255, 0.95);
        backdrop-filter: blur(10px);
        border: 1px solid rgba(255, 255, 255, 0.2);
      }

      .input-focus:focus {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px -8px rgba(102, 126, 234, 0.6);
        transition: all 0.3s ease;
      }

      .btn-primary {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        transition: all 0.3s ease;
      }

      .btn-primary:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 30px -10px rgba(102, 126, 234, 0.8);
      }

      .loading-spinner {
        border: 3px solid #f3f3f3;
        border-top: 3px solid #667eea;
        border-radius: 50%;
        width: 50px;
        height: 50px;
        animation: spin 1s linear infinite;
      }

      @keyframes spin {
        0% { transform: rotate(0deg); }
        100% { transform: rotate(360deg); }
      }

      .fade-in {
        animation: fadeIn 0.5s ease-in;
      }

      @keyframes fadeIn {
        from { opacity: 0; transform: translateY(10px); }
        to { opacity: 1; transform: translateY(0); }
      }

      .platform-chip {
        transition: all 0.2s ease;
      }

      .platform-chip:hover {
        transform: scale(1.05);
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      }

      .platform-chip input:checked + span {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        border-color: #667eea;
      }
  

    /* ============================================
       PROFESSIONAL ANIMATIONS & TRANSITIONS
       ============================================ */
    
    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes shake {
      0%, 100% { transform: translateX(0); }
      25% { transform: translateX(-10px); }
      75% { transform: translateX(10px); }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes slideInRight {
      from {
        opacity: 0;
        transform: translateX(100px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }
    
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.7; }
    }
    
    .animate-slideUp {
      animation: slideUp 0.3s ease-out;
    }
    
    .animate-shake {
      animation: shake 0.5s ease-in-out;
    }
    
    .animate-fadeIn {
      animation: fadeIn 0.3s ease-out;
    }
    
    .animate-slideInRight {
      animation: slideInRight 0.4s ease-out;
    }
    
    .animate-pulse {
      animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
    }
    
    /* Credit balance glow effect */
    #creditBalance {
      box-shadow: 0 0 20px rgba(255, 215, 0, 0.3);
    }
    
    #creditBalance:hover {
      box-shadow: 0 0 30px rgba(255, 215, 0, 0.5);
    }
    
    /* User dropdown arrow rotation */
    #userDropdown:not(.hidden) ~ #userMenuButton #userMenuChevron {
      transform: rotate(180deg);
    }
    
    /* Toast notification styles */
    .toast {
      position: fixed;
      bottom: 2rem;
      right: 2rem;
      max-width: 400px;
      padding: 1rem 1.5rem;
      border-radius: 0.75rem;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
      z-index: 9999;
      animation: slideInRight 0.4s ease-out;
      backdrop-filter: blur(10px);
    }
    
    .toast.success {
      background: linear-gradient(135deg, #10b981 0%, #059669 100%);
      color: white;
    }
    
    .toast.error {
      background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      color: white;
    }
    
    .toast.warning {
      background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
      color: white;
    }
    
    .toast.info {
      background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
      color: white;
    }
    
    /* Loading overlay */
    .loading-overlay {
      position: fixed;
      inset: 0;
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 999;
    }
    
    /* Smooth transitions for all interactive elements */
    button, input, select {
      transition: all 0.2s ease;
    }
    
    /* Focus states */
    input:focus, select:focus, textarea:focus {
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }
    
    /* Backdrop blur support */
    @supports (backdrop-filter: blur(10px)) or (-webkit-backdrop-filter: blur(10px)) {
      .backdrop-blur-sm {
        backdrop-filter: blur(10px);
        -webkit-backdrop-filter: blur(10px);
      }
    }
    
</style>
</head>
<body class="bg-gradient-to-br from-indigo-50 via-purple-50 to-pink-50 min-h-screen">
  <!-- Header -->
  <header class="gradient-bg text-white py-6 shadow-lg">
    <div class="container mx-auto px-4">
      <div class="flex items-center justify-between">
        <div class="flex items-center space-x-3">
          <i class="fas fa-bolt text-3xl"></i>
          <div>
            <h1 class="text-3xl font-bold">AdTargetAI</h1>
            <p class="text-sm opacity-90">AI-Powered Marketing Campaigns</p>
          </div>
        </div>
      <!-- USER SECTION (shown when logged in) -->
      <div id="userSection" class="hidden flex items-center space-x-4">
        <!-- Credit Balance Display with Animation -->
        <div id="creditBalanceContainer" class="relative">
          <div id="creditBalance" class="px-5 py-2.5 bg-white/25 backdrop-blur-sm rounded-xl flex items-center space-x-3 border border-white/30 shadow-lg transition-all hover:bg-white/30">
            <div class="relative">
              <i class="fas fa-coins text-yellow-300 text-xl animate-pulse"></i>
              <span class="absolute -top-1 -right-1 w-2 h-2 bg-green-400 rounded-full"></span>
            </div>
            <div class="flex flex-col">
              <span id="creditAmount" class="font-bold text-xl tracking-tight">--</span>
              <span class="text-xs opacity-75">credits</span>
            </div>
          </div>
          
          <!-- Credit change notification -->
          <div id="creditChangeNotif" class="hidden absolute -bottom-8 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-3 py-1 rounded-full text-xs font-semibold whitespace-nowrap shadow-lg animate-bounce">
            +10 credits
          </div>
        </div>
        
        <!-- Buy Credits Button -->
        <button onclick="window.location.href='/pricing'" class="px-5 py-2.5 bg-gradient-to-r from-yellow-400 to-orange-400 text-white rounded-xl hover:from-yellow-500 hover:to-orange-500 transition-all font-semibold shadow-lg hover:shadow-xl transform hover:-translate-y-0.5">
          <i class="fas fa-plus-circle mr-2"></i>Buy Credits
        </button>
        
        <!-- User Menu Dropdown -->
        <div class="relative">
          <button onclick="toggleUserMenu()" id="userMenuButton" class="flex items-center space-x-2 px-4 py-2.5 bg-white/20 backdrop-blur-sm rounded-xl hover:bg-white/30 transition-all border border-white/30 shadow-lg">
            <div class="w-8 h-8 bg-gradient-to-br from-purple-400 to-pink-400 rounded-full flex items-center justify-center">
              <i class="fas fa-user text-white text-sm"></i>
            </div>
            <span id="userName" class="font-semibold">User</span>
            <i class="fas fa-chevron-down text-xs transition-transform" id="userMenuChevron"></i>
          </button>
          
          <!-- Dropdown Menu -->
          <div id="userDropdown" class="hidden absolute right-0 mt-3 w-56 bg-white rounded-xl shadow-2xl py-2 z-50 border border-gray-200 animate-fadeIn">
            <div class="px-4 py-3 border-b border-gray-100">
              <p class="text-sm text-gray-500">Signed in as</p>
              <p id="userEmailDisplay" class="text-sm font-semibold text-gray-800 truncate">user@example.com</p>
            </div>
            <button onclick="viewDashboard()" class="w-full text-left px-4 py-2.5 hover:bg-gradient-to-r hover:from-indigo-50 hover:to-purple-50 flex items-center transition-all group">
              <i class="fas fa-chart-line mr-3 text-indigo-600 group-hover:scale-110 transition-transform"></i>
              <span class="text-gray-700 font-medium">Dashboard</span>
            </button>
            <button onclick="viewMyCampaigns()" class="w-full text-left px-4 py-2.5 hover:bg-gradient-to-r hover:from-indigo-50 hover:to-purple-50 flex items-center transition-all group">
              <i class="fas fa-folder-open mr-3 text-purple-600 group-hover:scale-110 transition-transform"></i>
              <span class="text-gray-700 font-medium">My Campaigns</span>
            </button>
            <button onclick="viewSettings()" class="w-full text-left px-4 py-2.5 hover:bg-gradient-to-r hover:from-indigo-50 hover:to-purple-50 flex items-center transition-all group">
              <i class="fas fa-cog mr-3 text-gray-600 group-hover:scale-110 transition-transform"></i>
              <span class="text-gray-700 font-medium">Settings</span>
            </button>
            <hr class="my-2">
            <button onclick="logout()" class="w-full text-left px-4 py-2.5 hover:bg-red-50 flex items-center transition-all group">
              <i class="fas fa-sign-out-alt mr-3 text-red-600 group-hover:scale-110 transition-transform"></i>
              <span class="text-red-600 font-medium">Logout</span>
            </button>
          </div>
        </div>
      </div>
      
      <!-- GUEST SECTION (shown when not logged in) -->
      <div id="guestSection" class="hidden flex items-center space-x-4">
        <button onclick="openLoginModal()" class="px-6 py-2.5 bg-white/20 backdrop-blur-sm rounded-xl hover:bg-white/30 transition-all font-semibold shadow-lg border border-white/30">
          <i class="fas fa-sign-in-alt mr-2"></i>Login
        </button>
        <button onclick="openRegisterModal()" class="px-6 py-2.5 bg-white text-indigo-600 rounded-xl hover:bg-gray-50 transition-all font-semibold shadow-lg">
          <i class="fas fa-user-plus mr-2"></i>Sign Up Free
        </button>
      </div>
      </div>
  </div>
</header>

  <!-- ============================================
       AUTHENTICATION MODALS - Professional Design
       ============================================ -->
  
  <!-- Login Modal -->
  <div id="loginModal" class="hidden fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full transform transition-all animate-slideUp">
      <!-- Header -->
      <div class="flex items-center justify-between mb-6">
        <div>
          <h2 class="text-3xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">Welcome Back!</h2>
          <p class="text-gray-500 text-sm mt-1">Sign in to continue creating campaigns</p>
        </div>
        <button onclick="closeLoginModal()" class="text-gray-400 hover:text-gray-600 transition-colors p-2 hover:bg-gray-100 rounded-full">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      
      <!-- Error Message -->
      <div id="loginError" class="hidden mb-4 p-4 bg-red-50 border-l-4 border-red-500 text-red-700 text-sm rounded-lg animate-shake">
        <div class="flex items-start">
          <i class="fas fa-exclamation-circle mr-3 mt-0.5"></i>
          <span id="loginErrorMessage"></span>
        </div>
      </div>
      
      <!-- Login Form -->
      <form id="loginForm" class="space-y-5">
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">
            <i class="fas fa-envelope mr-2 text-indigo-500"></i>Email Address
          </label>
          <input 
            type="email" 
            id="loginEmail" 
            required
            placeholder="you@company.com"
            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-indigo-500 transition-all placeholder-gray-400"
          />
        </div>
        
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">
            <i class="fas fa-lock mr-2 text-indigo-500"></i>Password
          </label>
          <input 
            type="password" 
            id="loginPassword" 
            required
            placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-indigo-500 transition-all placeholder-gray-400"
          />
        </div>
        
        <button 
          type="submit" 
          class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-bold py-4 rounded-xl hover:from-indigo-700 hover:to-purple-700 transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 flex items-center justify-center"
        >
          <i class="fas fa-sign-in-alt mr-2"></i>
          <span id="loginButtonText">Sign In</span>
          <div id="loginSpinner" class="hidden ml-3 w-5 h-5 border-3 border-white border-t-transparent rounded-full animate-spin"></div>
        </button>
      </form>
      
      <!-- Footer -->
      <div class="mt-6 text-center">
        <p class="text-sm text-gray-600">
          Don't have an account? 
          <button onclick="switchToRegister()" class="text-indigo-600 font-bold hover:text-indigo-700 hover:underline transition-colors">
            Sign up for free
          </button>
        </p>
      </div>
    </div>
  </div>
  
  <!-- Register Modal -->
  <div id="registerModal" class="hidden fixed inset-0 bg-black bg-opacity-60 backdrop-blur-sm flex items-center justify-center z-50 p-4">
    <div class="bg-white rounded-3xl shadow-2xl p-8 max-w-md w-full transform transition-all animate-slideUp">
      <!-- Header -->
      <div class="flex items-center justify-between mb-6">
        <div>
          <h2 class="text-3xl font-bold bg-gradient-to-r from-indigo-600 to-purple-600 bg-clip-text text-transparent">Get Started Free</h2>
          <p class="text-gray-500 text-sm mt-1">Create account and get 20 free credits!</p>
        </div>
        <button onclick="closeRegisterModal()" class="text-gray-400 hover:text-gray-600 transition-colors p-2 hover:bg-gray-100 rounded-full">
          <i class="fas fa-times text-xl"></i>
        </button>
      </div>
      
      <!-- Error Message -->
      <div id="registerError" class="hidden mb-4 p-4 bg-red-50 border-l-4 border-red-500 text-red-700 text-sm rounded-lg animate-shake">
        <div class="flex items-start">
          <i class="fas fa-exclamation-circle mr-3 mt-0.5"></i>
          <span id="registerErrorMessage"></span>
        </div>
      </div>
      
      <!-- Register Form -->
      <form id="registerForm" class="space-y-4">
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">
            <i class="fas fa-user mr-2 text-indigo-500"></i>Full Name
          </label>
          <input 
            type="text" 
            id="registerName" 
            required
            placeholder="John Doe"
            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-indigo-500 transition-all placeholder-gray-400"
          />
        </div>
        
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">
            <i class="fas fa-envelope mr-2 text-indigo-500"></i>Email Address
          </label>
          <input 
            type="email" 
            id="registerEmail" 
            required
            placeholder="you@company.com"
            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-indigo-500 transition-all placeholder-gray-400"
          />
        </div>
        
        <div>
          <label class="block text-sm font-semibold text-gray-700 mb-2">
            <i class="fas fa-lock mr-2 text-indigo-500"></i>Password
          </label>
          <input 
            type="password" 
            id="registerPassword" 
            required
            minlength="8"
            placeholder="At least 8 characters"
            class="w-full px-4 py-3 border-2 border-gray-200 rounded-xl focus:outline-none focus:border-indigo-500 transition-all placeholder-gray-400"
          />
          <p class="text-xs text-gray-500 mt-1 flex items-center">
            <i class="fas fa-info-circle mr-1"></i>Minimum 8 characters required
          </p>
        </div>
        
        <button 
          type="submit" 
          class="w-full bg-gradient-to-r from-indigo-600 to-purple-600 text-white font-bold py-4 rounded-xl hover:from-indigo-700 hover:to-purple-700 transition-all shadow-lg hover:shadow-xl transform hover:-translate-y-0.5 flex items-center justify-center"
        >
          <i class="fas fa-rocket mr-2"></i>
          <span id="registerButtonText">Create Account</span>
          <div id="registerSpinner" class="hidden ml-3 w-5 h-5 border-3 border-white border-t-transparent rounded-full animate-spin"></div>
        </button>
      </form>
      
      <!-- Footer -->
      <div class="mt-6 text-center">
        <p class="text-sm text-gray-600">
          Already have an account? 
          <button onclick="switchToLogin()" class="text-indigo-600 font-bold hover:text-indigo-700 hover:underline transition-colors">
            Sign in
          </button>
        </p>
      </div>
      
      <!-- Benefits -->
      <div class="mt-6 pt-6 border-t border-gray-200">
        <p class="text-xs font-semibold text-gray-700 mb-3">What you'll get:</p>
        <div class="space-y-2 text-xs text-gray-600">
          <div class="flex items-center">
            <i class="fas fa-check-circle text-green-500 mr-2"></i>
            <span>20 free credits to get started</span>
          </div>
          <div class="flex items-center">
            <i class="fas fa-check-circle text-green-500 mr-2"></i>
            <span>AI-powered campaign generation</span>
          </div>
          <div class="flex items-center">
            <i class="fas fa-check-circle text-green-500 mr-2"></i>
            <span>Multi-platform deployment</span>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Main Container -->
  <div class="container mx-auto px-4 py-8">
    <!-- Low Balance Warning -->
<div id="lowBalanceWarning" class="hidden max-w-5xl mx-auto mb-6 bg-yellow-50 border-l-4 border-yellow-400 p-4 rounded-lg">
  <div class="flex items-start">
    <i class="fas fa-exclamation-triangle text-yellow-600 text-xl mr-3 mt-0.5"></i>
    <div class="flex-1">
      <h3 class="font-semibold text-yellow-800">Low Credit Balance</h3>
      <p class="text-sm text-yellow-700 mt-1">
        You have <span id="lowBalanceAmount" class="font-bold"></span> credits left. 
        That's enough for about <span id="campaignsLeft" class="font-bold"></span> campaign(s).
      </p>
      <button onclick="quickTopUp()" class="mt-2 px-4 py-2 bg-yellow-600 text-white rounded-lg text-sm font-semibold hover:bg-yellow-700 transition">
        <i class="fas fa-bolt mr-1"></i> Quick Top-Up
      </button>
    </div>
    <button onclick="dismissLowBalanceWarning()" class="text-yellow-600 hover:text-yellow-800">
      <i class="fas fa-times"></i>
    </button>
  </div>
</div>
<!-- Campaign Form Card -->
<div class="max-w-5xl mx-auto">
  <div class="glass-effect rounded-2xl shadow-2xl p-8 mb-8 fade-in">
    
    <!-- Progress Indicator -->
    <div class="flex items-center justify-between mb-8">
      <div class="flex-1">
        <div class="flex items-center">
          <div id="step1" class="step-indicator active flex items-center">
            <div class="w-10 h-10 rounded-full bg-gradient-to-r from-indigo-500 to-purple-500 flex items-center justify-center text-white font-bold">1</div>
            <span class="ml-3 font-semibold">Product Details</span>
          </div>
          <div class="flex-1 h-1 bg-gray-200 mx-4"></div>
          <div id="step2" class="step-indicator flex items-center opacity-50">
            <div class="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center text-white font-bold">2</div>
            <span class="ml-3 font-semibold">Campaign Setup</span>
          </div>
          <div class="flex-1 h-1 bg-gray-200 mx-4"></div>
          <div id="step3" class="step-indicator flex items-center opacity-50">
            <div class="w-10 h-10 rounded-full bg-gray-300 flex items-center justify-center text-white font-bold">3</div>
            <span class="ml-3 font-semibold">Generate</span>
          </div>
        </div>
      </div>
    </div>

    <form id="campaignForm" class="space-y-8">
      
      <!-- Section 1: Product Info -->
      <div id="section1" class="space-y-6">
        <h2 class="text-2xl font-bold text-gray-800 mb-4 flex items-center">
          <i class="fas fa-box-open mr-3 text-indigo-600"></i>
          Product Information
        </h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="form-group">
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              <i class="fas fa-tag mr-2 text-indigo-500"></i>Product Name *
            </label>
            <input 
              id="product_name" 
              type="text" 
              required
              placeholder="e.g., Premium Wireless Headphones"
              class="w-full px-4 py-3 rounded-lg border-2 border-gray-200 input-focus focus:border-indigo-500 transition-all outline-none"
            />
          </div>
          
          <div class="form-group">
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              <i class="fas fa-layer-group mr-2 text-indigo-500"></i>Category *
            </label>
            <input 
              id="category" 
              type="text" 
              required
              placeholder="e.g., Electronics, Fashion, Beauty"
              class="w-full px-4 py-3 rounded-lg border-2 border-gray-200 input-focus focus:border-indigo-500 transition-all outline-none"
            />
          </div>
        </div>

        <div class="form-group">
          <label class="block text-sm font-semibold text-gray-700 mb-2">
            <i class="fas fa-align-left mr-2 text-indigo-500"></i>Product Description *
          </label>
          <textarea 
            id="product_description" 
            required 
            rows="4"
            placeholder="Describe your product's key features, benefits, and what makes it special..."
            class="w-full px-4 py-3 rounded-lg border-2 border-gray-200 input-focus focus:border-indigo-500 transition-all outline-none resize-none"
          ></textarea>
          <div class="flex justify-between mt-2">
            <span class="text-xs text-gray-500">
              <i class="fas fa-lightbulb mr-1"></i>Tip: Include unique selling points
            </span>
            <span id="descLength" class="text-xs text-gray-500">0 / 500</span>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="form-group">
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              <i class="fas fa-link mr-2 text-indigo-500"></i>Landing Page URL *
            </label>
            <input 
              id="landing_page" 
              type="url" 
              required
              placeholder="https://yourwebsite.com/product"
              class="w-full px-4 py-3 rounded-lg border-2 border-gray-200 input-focus focus:border-indigo-500 transition-all outline-none"
            />
          </div>
          
          <div class="form-group">
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              <i class="fas fa-dollar-sign mr-2 text-indigo-500"></i>Price Range *
            </label>
            <select 
              id="price_range" 
              required
              class="w-full px-4 py-3 rounded-lg border-2 border-gray-200 input-focus focus:border-indigo-500 transition-all outline-none"
            >
              <option value="">Select Price Range...</option>
              <option value="budget">ðŸ’° Budget ($0 - $50)</option>
              <option value="mid-range">ðŸ’µ Mid-Range ($50 - $200)</option>
              <option value="premium">ðŸ’Ž Premium ($200 - $500)</option>
              <option value="luxury">ðŸ‘‘ Luxury ($500+)</option>
            </select>
          </div>
        </div>

        <!-- Image Upload with Preview -->
        <div class="form-group">
          <label class="block text-sm font-semibold text-gray-700 mb-2">
            <i class="fas fa-image mr-2 text-indigo-500"></i>Product Image *
          </label>
          <div class="relative">
            <input 
              id="imageFile" 
              type="file" 
              accept="image/*"
              class="hidden"
            />
            <div 
              id="imageDropZone"
              class="border-2 border-dashed border-gray-300 rounded-lg p-8 text-center cursor-pointer hover:border-indigo-500 transition-all"
              onclick="document.getElementById('imageFile').click()"
            >
              <div id="imagePrompt">
                <i class="fas fa-cloud-upload-alt text-5xl text-gray-400 mb-3"></i>
                <p class="text-gray-600 font-semibold">Click to upload or drag and drop</p>
                <p class="text-sm text-gray-500 mt-1">PNG, JPG, GIF up to 10MB</p>
                <p class="text-xs text-gray-400 mt-2">Recommended: 1200Ã—628px for best results</p>
              </div>
              <div id="imagePreviewContainer" class="hidden">
                <img id="imagePreview" class="max-w-full h-48 mx-auto rounded-lg shadow-lg" />
                <p class="text-sm text-gray-600 mt-3">
                  <i class="fas fa-check-circle text-green-500 mr-1"></i>
                  Image uploaded successfully
                </p>
              </div>
            </div>
          </div>
        </div>

        <div class="flex justify-end">
          <button 
            type="button" 
            onclick="showSection(2)"
            class="btn-primary text-white px-8 py-3 rounded-lg font-semibold shadow-lg"
          >
            Next: Campaign Setup
            <i class="fas fa-arrow-right ml-2"></i>
          </button>
        </div>
      </div>

      <!-- Section 2: Campaign Setup -->
      <div id="section2" class="space-y-6 hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-2xl font-bold text-gray-800 flex items-center">
            <i class="fas fa-bullseye mr-3 text-indigo-600"></i>
            Campaign Configuration
          </h2>
          <button 
            type="button" 
            onclick="showSection(1)"
            class="text-indigo-600 hover:text-indigo-700 font-semibold"
          >
            <i class="fas fa-arrow-left mr-2"></i>Back
          </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div class="form-group">
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              <i class="fas fa-wallet mr-2 text-indigo-500"></i>Daily Budget *
            </label>
            <div class="relative">
              <span class="absolute left-4 top-1/2 -translate-y-1/2 text-gray-500 font-bold">$</span>
              <input 
                id="daily_budget" 
                type="number" 
                required 
                min="1" 
                step="0.01"
                placeholder="50.00"
                class="w-full pl-8 pr-4 py-3 rounded-lg border-2 border-gray-200 input-focus focus:border-indigo-500 transition-all outline-none"
              />
            </div>
          </div>
          
          <div class="form-group">
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              <i class="fas fa-calendar-alt mr-2 text-indigo-500"></i>Campaign Days *
            </label>
            <input 
              id="campaign_days" 
              type="number" 
              required 
              min="1" 
              max="365"
              placeholder="30"
              class="w-full px-4 py-3 rounded-lg border-2 border-gray-200 input-focus focus:border-indigo-500 transition-all outline-none"
            />
          </div>
          
          <div class="form-group">
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              <i class="fas fa-chart-line mr-2 text-indigo-500"></i>Total Budget
            </label>
            <div class="flex items-center px-4 py-3 rounded-lg bg-indigo-50 border-2 border-indigo-200">
              <span class="font-bold text-indigo-600 text-lg" id="totalBudget">$0.00</span>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="form-group">
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              <i class="fas fa-calendar-day mr-2 text-indigo-500"></i>Start Date (Optional)
            </label>
            <input 
              id="start_date" 
              type="date"
              class="w-full px-4 py-3 rounded-lg border-2 border-gray-200 input-focus focus:border-indigo-500 transition-all outline-none"
            />
          </div>
          
          <div class="form-group">
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              <i class="fas fa-calendar-check mr-2 text-indigo-500"></i>End Date (Optional)
            </label>
            <input 
              id="end_date" 
              type="date"
              class="w-full px-4 py-3 rounded-lg border-2 border-gray-200 input-focus focus:border-indigo-500 transition-all outline-none"
            />
          </div>
        </div>

        <!-- Platform Selection -->
        <div class="form-group">
          <label class="block text-sm font-semibold text-gray-700 mb-3">
            <i class="fas fa-share-alt mr-2 text-indigo-500"></i>Select Platforms *
          </label>
          <div id="platformsError" class="text-red-600 text-sm mb-2 hidden flex items-center">
            <i class="fas fa-exclamation-circle mr-2"></i>
            Please select at least one platform
          </div>
          <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
            <label class="platform-chip cursor-pointer">
              <input type="checkbox" name="platforms" value="facebook" checked class="hidden peer" />
              <span class="flex items-center justify-center px-4 py-3 rounded-lg border-2 border-gray-200 peer transition-all">
                <i class="fab fa-facebook text-blue-600 text-xl mr-2"></i>
                <span class="font-semibold">Facebook</span>
              </span>
            </label>
            
            <label class="platform-chip cursor-pointer">
              <input type="checkbox" name="platforms" value="instagram" class="hidden peer" />
              <span class="flex items-center justify-center px-4 py-3 rounded-lg border-2 border-gray-200 peer transition-all">
                <i class="fab fa-instagram text-pink-600 text-xl mr-2"></i>
                <span class="font-semibold">Instagram</span>
              </span>
            </label>
            
            <label class="platform-chip cursor-pointer">
              <input type="checkbox" name="platforms" value="google" class="hidden peer" />
              <span class="flex items-center justify-center px-4 py-3 rounded-lg border-2 border-gray-200 peer transition-all">
                <i class="fab fa-google text-red-600 text-xl mr-2"></i>
                <span class="font-semibold">Google</span>
              </span>
            </label>
            
            <label class="platform-chip cursor-pointer">
              <input type="checkbox" name="platforms" value="tiktok" class="hidden peer" />
              <span class="flex items-center justify-center px-4 py-3 rounded-lg border-2 border-gray-200 peer transition-all">
                <i class="fab fa-tiktok text-black text-xl mr-2"></i>
                <span class="font-semibold">TikTok</span>
              </span>
            </label>
            
            <label class="platform-chip cursor-pointer">
              <input type="checkbox" name="platforms" value="linkedin" class="hidden peer" />
              <span class="flex items-center justify-center px-4 py-3 rounded-lg border-2 border-gray-200 peer transition-all">
                <i class="fab fa-linkedin text-blue-700 text-xl mr-2"></i>
                <span class="font-semibold">LinkedIn</span>
              </span>
            </label>
            
            <label class="platform-chip cursor-pointer">
              <input type="checkbox" name="platforms" value="youtube" class="hidden peer" />
              <span class="flex items-center justify-center px-4 py-3 rounded-lg border-2 border-gray-200 peer transition-all">
                <i class="fab fa-youtube text-red-600 text-xl mr-2"></i>
                <span class="font-semibold">YouTube</span>
              </span>
            </label>
            
            <label class="platform-chip cursor-pointer">
              <input type="checkbox" name="platforms" value="x" class="hidden peer" />
              <span class="flex items-center justify-center px-4 py-3 rounded-lg border-2 border-gray-200 peer transition-all">
                <i class="fab fa-x-twitter text-black text-xl mr-2"></i>
                <span class="font-semibold">X</span>
              </span>
            </label>
            
            <label class="platform-chip cursor-pointer">
              <input type="checkbox" name="platforms" value="pinterest" class="hidden peer" />
              <span class="flex items-center justify-center px-4 py-3 rounded-lg border-2 border-gray-200 peer transition-all">
                <i class="fab fa-pinterest text-red-700 text-xl mr-2"></i>
                <span class="font-semibold">Pinterest</span>
              </span>
            </label>
          </div>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
          <div class="form-group">
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              <i class="fas fa-mouse-pointer mr-2 text-indigo-500"></i>Call to Action *
            </label>
            <input 
              id="call_to_action" 
              type="text" 
              required
              placeholder="e.g., Shop Now, Learn More, Get Started"
              class="w-full px-4 py-3 rounded-lg border-2 border-gray-200 input-focus focus:border-indigo-500 transition-all outline-none"
            />
          </div>
          
          <div class="form-group">
            <label class="block text-sm font-semibold text-gray-700 mb-2">
              <i class="fas fa-crosshairs mr-2 text-indigo-500"></i>Campaign Objective *
            </label>
            <select 
              id="objective" 
              required
              class="w-full px-4 py-3 rounded-lg border-2 border-gray-200 input-focus focus:border-indigo-500 transition-all outline-none"
            >
              <option value="LINK_CLICKS">ðŸŽ¯ Drive Traffic</option>
              <option value="CONVERSIONS">ðŸ’° Get Conversions</option>
              <option value="BRAND_AWARENESS">ðŸ“¢ Brand Awareness</option>
              <option value="ENGAGEMENT">ðŸ’¬ Boost Engagement</option>
            </select>
          </div>
        </div>

        <div class="flex justify-between items-center pt-6">
          <button 
            type="button"
            id="saveDraftBtn" 
            class="px-6 py-3 bg-gray-100 text-gray-700 rounded-lg font-semibold hover:bg-gray-200 transition-all"
          >
            <i class="fas fa-save mr-2"></i>Save Draft
          </button>
          <button 
            type="button" 
            onclick="showSection(3)"
            class="btn-primary text-white px-8 py-3 rounded-lg font-semibold shadow-lg"
          >
            Review & Generate
            <i class="fas fa-arrow-right ml-2"></i>
          </button>
        </div>
      </div>

      <!-- Section 3: Review & Generate -->
      <div id="section3" class="space-y-6 hidden">
        <div class="flex items-center justify-between mb-4">
          <h2 class="text-2xl font-bold text-gray-800 flex items-center">
            <i class="fas fa-check-circle mr-3 text-indigo-600"></i>
            Review & Generate
          </h2>
          <button 
            type="button" 
            onclick="showSection(2)"
            class="text-indigo-600 hover:text-indigo-700 font-semibold"
          >
            <i class="fas fa-arrow-left mr-2"></i>Back
          </button>
        </div>

        <div id="reviewSummary" class="bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl p-6 border-2 border-indigo-100">
          <h3 class="font-bold text-lg mb-4 text-gray-800">Campaign Summary</h3>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
            <div>
              <span class="text-gray-600">Product:</span>
              <span class="font-semibold ml-2" id="review_product">-</span>
            </div>
            <div>
              <span class="text-gray-600">Budget:</span>
              <span class="font-semibold ml-2" id="review_budget">-</span>
            </div>
            <div>
              <span class="text-gray-600">Platforms:</span>
              <span class="font-semibold ml-2" id="review_platforms">-</span>
            </div>
            <div>
              <span class="text-gray-600">Duration:</span>
              <span class="font-semibold ml-2" id="review_days">-</span>
            </div>
          </div>
        </div>

        <div class="bg-blue-50 border-l-4 border-blue-500 p-4 rounded">
          <div class="flex items-start">
            <i class="fas fa-info-circle text-blue-500 mt-1 mr-3"></i>
            <div>
              <h4 class="font-semibold text-blue-800 mb-1">What happens next?</h4>
              <ul class="text-sm text-blue-700 space-y-1">
                <li>âœ“ AI analyzes your product and target audience</li>
                <li>âœ“ Generates optimized ad copy and targeting</li>
                <li>âœ“ Creates platform-specific campaign formats</li>
                <li>âœ“ Provides performance predictions</li>
              </ul>
            </div>
          </div>
        </div>
<div id="costPreview" class="bg-gradient-to-r from-purple-50 to-blue-50 rounded-lg p-6 border-2 border-purple-200 mb-4">
  <div class="flex items-center justify-between">
    <div>
      <h3 class="font-semibold text-gray-800 mb-1">
        <i class="fas fa-calculator mr-2 text-purple-600"></i>Campaign Cost
      </h3>
      <p class="text-sm text-gray-600">Estimated credits required</p>
    </div>
    <div class="text-right">
      <div class="text-3xl font-bold text-purple-600">
        <span id="estimatedCost">10</span>
        <i class="fas fa-bolt text-yellow-500 ml-1"></i>
      </div>
      <p class="text-xs text-gray-500 mt-1">
        Balance after: <span id="balanceAfter" class="font-semibold">--</span>
      </p>
    </div>
  </div>
</div>
        <div class="flex justify-center pt-6">
          <button 
            id="submitBtn"
            type="submit"
            class="btn-primary text-white px-12 py-4 rounded-lg font-bold text-lg shadow-xl hover:shadow-2xl transition-all"
          >
            <i class="fas fa-magic mr-3"></i>
            Generate AI Campaign
          </button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Loading State -->
<div id="loading" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
  <div class="glass-effect rounded-2xl p-8 text-center max-w-md">
    <div class="loading-spinner mx-auto mb-4"></div>
    <h3 class="text-xl font-bold text-gray-800 mb-2">Generating Your Campaign</h3>
    <p class="text-gray-600">Our AI is analyzing your product and creating optimized campaigns...</p>
    <div class="mt-4">
      <div class="flex justify-between text-sm text-gray-500 mb-2">
        <span id="loadingStep">Analyzing product...</span>
        <span id="loadingProgress">0%</span>
      </div>
      <div class="w-full bg-gray-200 rounded-full h-2">
        <div id="loadingBar" class="gradient-bg h-2 rounded-full transition-all duration-500" style="width: 0%"></div>
      </div>
    </div>
  </div>
</div>

<!-- Results Container -->
<div id="results" class="hidden max-w-6xl mx-auto"></div>

<!-- Export UI Container -->
<div id="facebookExport" class="hidden max-w-6xl mx-auto mt-8"></div>
  </div>
  <!-- Confirmation Modal -->
  <div id="confirmModal" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center">
    <div class="glass-effect rounded-2xl p-8 max-w-md w-full shadow-2xl">
      <div class="text-center mb-6">
        <div class="w-16 h-16 bg-yellow-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <i class="fas fa-exclamation-triangle text-yellow-600 text-2xl"></i>
        </div>
        <h3 class="text-2xl font-bold text-gray-800 mb-2">Create Real Ads?</h3>
        <p class="text-gray-600">This will create live advertisements in your connected ad accounts. This action may spend real money.</p>
      </div>
  <div class="mb-6">
    <label class="block text-sm font-semibold text-gray-700 mb-2">Admin API Key</label>
    <input 
      id="adminKeyInput" 
      type="password" 
      placeholder="Enter your admin key"
      class="w-full px-4 py-3 rounded-lg border-2 border-gray-200 focus:border-yellow-500 transition-all outline-none"
    />
  </div>
  
  <div class="flex gap-3">
    <button 
      id="cancelModal"
      class="flex-1 px-6 py-3 bg-gray-100 text-gray-700 rounded-lg font-semibold hover:bg-gray-200 transition-all"
    >
      Cancel
    </button>
    <button 
      id="confirmModalBtn"
      class="flex-1 px-6 py-3 bg-gradient-to-r from-yellow-500 to-orange-500 text-white rounded-lg font-semibold hover:shadow-lg transition-all"
    >
      Confirm & Create
    </button>
  </div>
</div>
  </div>
  <!-- Insufficient Credits Modal -->
<div id="insufficientCreditsModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
  <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full mx-4 p-8">
    <div class="text-center mb-6">
      <div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
        <i class="fas fa-exclamation-triangle text-red-600 text-4xl"></i>
      </div>
      <h3 class="text-2xl font-bold text-gray-800 mb-2">Insufficient Credits</h3>
      <p class="text-gray-600">
        You need <span id="requiredCredits" class="font-bold text-red-600"></span> credits 
        but only have <span id="currentCredits" class="font-bold"></span> credits.
      </p>
    </div>

    <div id="recommendedPackage" class="bg-gradient-to-r from-green-50 to-blue-50 rounded-lg p-4 mb-6">
      <p class="text-sm font-semibold text-gray-700 mb-2">
        <i class="fas fa-lightbulb text-yellow-500 mr-1"></i> Recommended Package
      </p>
      <div class="flex items-center justify-between">
        <div>
          <div class="text-2xl font-bold text-green-600">
            <span id="recommendedCredits"></span> Credits
          </div>
          <div class="text-sm text-gray-600" id="recommendedReason"></div>
        </div>
        <div class="text-right">
          <div class="text-xl font-bold text-gray-800" id="recommendedPrice"></div>
        </div>
      </div>
    </div>

    <div class="space-y-3">
      <button 
        onclick="proceedToQuickTopUp()" 
        class="w-full bg-gradient-to-r from-green-500 to-blue-500 text-white py-3 rounded-lg font-semibold hover:from-green-600 hover:to-blue-600 transition"
      >
        <i class="fas fa-bolt mr-2"></i>Quick Top-Up Now
      </button>
      <button 
        onclick="closeInsufficientCreditsModal()" 
        class="w-full bg-gray-200 text-gray-700 py-3 rounded-lg font-semibold hover:bg-gray-300 transition"
      >
        Cancel
      </button>
    </div>
  </div>
</div>
<script>
document.addEventListener('DOMContentLoaded', function() {

    // ==========================================
    // AUTHENTICATION SYSTEM
    // ==========================================
    
    // Initialize authentication on page load
    initializeAuth();
    
    function initializeAuth() {
      checkAuthStatus();
      setupAuthListeners();
    }
    
    // Check if user is logged in
    function checkAuthStatus() {
      const token = localStorage.getItem('token');
      const userEmail = localStorage.getItem('userEmail');
      const userName = localStorage.getItem('userName');
      
      if (token) {
        // User is logged in
        document.getElementById('guestSection').classList.add('hidden');
        document.getElementById('userSection').classList.remove('hidden');
        
        // Set user info
        if (userName) {
          document.getElementById('userName').textContent = userName.split(' ')[0];
        } else if (userEmail) {
          document.getElementById('userName').textContent = userEmail.split('@')[0];
        }
        
        if (userEmail) {
          document.getElementById('userEmailDisplay').textContent = userEmail;
        }
        
        // Load credit balance
        loadUserBalance();
      } else {
        // User is not logged in
        document.getElementById('guestSection').classList.remove('hidden');
        document.getElementById('userSection').classList.add('hidden');
      }
    }
    
    // Setup authentication event listeners
    function setupAuthListeners() {
      // Login form
      const loginForm = document.getElementById('loginForm');
      if (loginForm) {
        loginForm.addEventListener('submit', handleLogin);
      }
      
      // Register form
      const registerForm = document.getElementById('registerForm');
      if (registerForm) {
        registerForm.addEventListener('submit', handleRegister);
      }
      
      // Close dropdown when clicking outside
      document.addEventListener('click', function(event) {
        const userMenu = document.getElementById('userMenuButton');
        const dropdown = document.getElementById('userDropdown');
        
        if (userMenu && dropdown && !userMenu.contains(event.target) && !dropdown.contains(event.target)) {
          dropdown.classList.add('hidden');
        }
      });
    }
    
    // Modal controls
    function openLoginModal() {
      document.getElementById('loginModal').classList.remove('hidden');
      setTimeout(() => {
        document.getElementById('loginEmail').focus();
      }, 100);
    }
    
    function closeLoginModal() {
      document.getElementById('loginModal').classList.add('hidden');
      document.getElementById('loginError').classList.add('hidden');
      document.getElementById('loginForm').reset();
    }
    
    function openRegisterModal() {
      document.getElementById('registerModal').classList.remove('hidden');
      setTimeout(() => {
        document.getElementById('registerName').focus();
      }, 100);
    }
    
    function closeRegisterModal() {
      document.getElementById('registerModal').classList.add('hidden');
      document.getElementById('registerError').classList.add('hidden');
      document.getElementById('registerForm').reset();
    }
    
    function switchToRegister() {
      closeLoginModal();
      setTimeout(() => openRegisterModal(), 200);
    }
    
    function switchToLogin() {
      closeRegisterModal();
      setTimeout(() => openLoginModal(), 200);
    }
    
    function toggleUserMenu() {
      const dropdown = document.getElementById('userDropdown');
      dropdown.classList.toggle('hidden');
    }
    
    // Handle login
    async function handleLogin(e) {
      e.preventDefault();
      
      const email = document.getElementById('loginEmail').value;
      const password = document.getElementById('loginPassword').value;
      
      // Show loading
      document.getElementById('loginButtonText').textContent = 'Signing In...';
      document.getElementById('loginSpinner').classList.remove('hidden');
      document.getElementById('loginError').classList.add('hidden');
      
      try {
        const response = await fetch('/api/auth/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: new URLSearchParams({
            username: email,
            password: password
          })
        });
        
        const data = await response.json();
        
        if (response.ok) {
          // Store credentials
          localStorage.setItem('token', data.access_token);
          localStorage.setItem('userEmail', email);
          
          if (data.user && data.user.full_name) {
            localStorage.setItem('userName', data.user.full_name);
          }
          
          // Success!
          showToast('Welcome back! ðŸŽ‰', 'success');
          closeLoginModal();
          checkAuthStatus();
          
        } else {
          // Show error
          document.getElementById('loginErrorMessage').textContent = 
            data.detail || 'Invalid email or password. Please try again.';
          document.getElementById('loginError').classList.remove('hidden');
        }
      } catch (error) {
        console.error('Login error:', error);
        document.getElementById('loginErrorMessage').textContent = 
          'Connection error. Please check your internet and try again.';
        document.getElementById('loginError').classList.remove('hidden');
      } finally {
        // Reset button
        document.getElementById('loginButtonText').textContent = 'Sign In';
        document.getElementById('loginSpinner').classList.add('hidden');
      }
    }
    
    // Handle registration
    async function handleRegister(e) {
      e.preventDefault();
      
      const name = document.getElementById('registerName').value;
      const email = document.getElementById('registerEmail').value;
      const password = document.getElementById('registerPassword').value;
      
      // Show loading
      document.getElementById('registerButtonText').textContent = 'Creating Account...';
      document.getElementById('registerSpinner').classList.remove('hidden');
      document.getElementById('registerError').classList.add('hidden');
      
      try {
        const response = await fetch('/api/auth/register', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({
            email: email,
            password: password,
            full_name: name
          })
        });
        
        const data = await response.json();
        
        if (response.ok) {
          // Store credentials
          localStorage.setItem('token', data.access_token);
          localStorage.setItem('userEmail', email);
          localStorage.setItem('userName', name);
          
          // Success!
          const credits = data.credits || 20;
          showToast(`ðŸŽ‰ Welcome to AdTargetAI, ${name.split(' ')[0]}! You have ${credits} free credits!`, 'success');
          closeRegisterModal();
          checkAuthStatus();
          
          // Show credit balance with animation
          setTimeout(() => {
            showCreditChangeNotification(`+${credits}`);
          }, 1000);
          
        } else {
          // Show error
          document.getElementById('registerErrorMessage').textContent = 
            data.detail || 'Registration failed. Please try again.';
          document.getElementById('registerError').classList.remove('hidden');
        }
      } catch (error) {
        console.error('Registration error:', error);
        document.getElementById('registerErrorMessage').textContent = 
          'Connection error. Please check your internet and try again.';
        document.getElementById('registerError').classList.remove('hidden');
      } finally {
        // Reset button
        document.getElementById('registerButtonText').textContent = 'Create Account';
        document.getElementById('registerSpinner').classList.add('hidden');
      }
    }
    
    // Logout
    function logout() {
      if (confirm('Are you sure you want to logout?')) {
        localStorage.removeItem('token');
        localStorage.removeItem('userEmail');
        localStorage.removeItem('userName');
        
        showToast('Logged out successfully. See you soon! ðŸ‘‹', 'info');
        
        setTimeout(() => {
          window.location.reload();
        }, 1500);
      }
    }
    
    // Navigation functions
    function viewDashboard() {
      toggleUserMenu();
      showToast('Dashboard coming soon! ðŸ“Š', 'info');
    }
    
    function viewMyCampaigns() {
      toggleUserMenu();
      showToast('Campaigns history coming soon! ðŸ“', 'info');
    }
    
    function viewSettings() {
      toggleUserMenu();
      showToast('Settings page coming soon! âš™ï¸', 'info');
    }
    
    // ==========================================
    // CREDIT NOTIFICATION SYSTEM
    // ==========================================
    
    function showCreditChangeNotification(change) {
      const notif = document.getElementById('creditChangeNotif');
      if (!notif) return;
      
      notif.textContent = change;
      notif.classList.remove('hidden');
      
      setTimeout(() => {
        notif.classList.add('hidden');
      }, 3000);
    }
    
    // Enhanced loadUserBalance with animation
    const originalLoadUserBalance = loadUserBalance;
    loadUserBalance = async function() {
      const oldBalance = document.getElementById('creditAmount').textContent;
      const result = await originalLoadUserBalance();
      
      if (result && oldBalance !== '--') {
        const newBalance = result.credits_balance;
        const oldBalanceNum = parseFloat(oldBalance);
        
        if (!isNaN(oldBalanceNum) && oldBalanceNum !== newBalance) {
          const change = newBalance - oldBalanceNum;
          showCreditChangeNotification(change > 0 ? `+${change}` : `${change}`);
        }
      }
      
      return result;
    };
    
    // ==========================================
    // ENHANCED TOAST NOTIFICATIONS
    // ==========================================
    
    function showToast(message, type = 'info') {
      // Remove existing toasts
      const existingToasts = document.querySelectorAll('.toast');
      existingToasts.forEach(toast => toast.remove());
      
      const toast = document.createElement('div');
      toast.className = `toast ${type}`;
      
      const icons = {
        success: 'fa-check-circle',
        error: 'fa-exclamation-circle',
        warning: 'fa-exclamation-triangle',
        info: 'fa-info-circle'
      };
      
      toast.innerHTML = `
        <div class="flex items-center">
          <i class="fas ${icons[type]} text-2xl mr-3"></i>
          <div class="flex-1">
            <p class="font-semibold">${message}</p>
          </div>
          <button onclick="this.parentElement.parentElement.remove()" class="ml-4 opacity-75 hover:opacity-100">
            <i class="fas fa-times"></i>
          </button>
        </div>
      `;
      
      document.body.appendChild(toast);
      
      setTimeout(() => {
        toast.style.animation = 'slideInRight 0.4s ease-out reverse';
        setTimeout(() => toast.remove(), 400);
      }, 5000);
    }
    
    // ==========================================
    // GLOBAL HELPERS
    // ==========================================
    function el(id) { return document.getElementById(id); }

    // ==========================================
// CREDIT SYSTEM FUNCTIONS
// ==========================================

// Get authentication token
function getAuthToken() {
  return localStorage.getItem('token') || sessionStorage.getItem('token') || '';
}

// Set authentication token
function setAuthToken(token) {
  localStorage.setItem('token', token);
  sessionStorage.setItem('token', token);
}

// Load user's credit balance
async function loadUserBalance() {
  const token = getAuthToken();
  if (!token) {
    console.log('No token - user not logged in');
    return null;
  }
  
  try {
    const response = await fetch('/api/v1/payments/balance', {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    
    if (!response.ok) {
      console.error('Balance load failed:', response.status);
      return null;
    }
    
    const data = await response.json();
    console.log('âœ… Balance loaded:', data.credits_balance);
    
    // Update credit display in header
    const creditAmountEl = el('creditAmount');
    if (creditAmountEl) {
      creditAmountEl.textContent = data.credits_balance;
      el('creditBalance').style.display = 'flex'; // Show the balance widget
    }
    
    // Show low balance warning if needed
    if (data.is_low_balance) {
      const warningEl = el('lowBalanceWarning');
      if (warningEl) {
        el('lowBalanceAmount').textContent = data.credits_balance;
        warningEl.classList.remove('hidden');
      }
    }
    
    return data;
  } catch (error) {
    console.error('âŒ Balance load error:', error);
    return null;
  }
}

// Check if user has enough credits for this campaign
async function checkCampaignCredits(campaignData) {
  const token = getAuthToken();
  if (!token) {
    throw new Error('Please login to create campaigns');
  }
  
  try {
    // Get current balance first
    const balanceResponse = await fetch('/api/v1/payments/balance', {
      headers: { 'Authorization': `Bearer ${token}` }
    });
    
    if (!balanceResponse.ok) {
      throw new Error('Failed to check balance');
    }
    
    const balanceData = await balanceResponse.json();
    const currentBalance = balanceData.credits_balance;
    
    // Calculate required credits (10 credits per campaign)
    const requiredCredits = 10;
    
    console.log(`ðŸ’³ Credit check: Need ${requiredCredits}, Have ${currentBalance}`);
    
    return {
      has_enough_credits: currentBalance >= requiredCredits,
      required_credits: requiredCredits,
      current_balance: currentBalance,
      is_low_balance: currentBalance < 20,
      recommended_topup: currentBalance < requiredCredits ? {
        credits: 50,
        price_paise: 5000,
        reason: 'Get 50 credits to continue creating campaigns'
      } : null
    };
    
  } catch (error) {
    console.error('âŒ Credit check error:', error);
    throw error;
  }
}

// Show insufficient credits modal
function showInsufficientCreditsModal(required, current, recommended) {
  const modal = el('insufficientCreditsModal');
  if (!modal) {
    // Fallback if modal HTML not added yet
    const goToPricing = confirm(
      `You need ${required} credits but only have ${current} credits.\n\nBuy more credits now?`
    );
    if (goToPricing) {
      window.location.href = '/pricing';
    }
    return;
  }
  
  el('requiredCredits').textContent = required;
  el('currentCredits').textContent = current;
  
  // Show recommended package if available
  if (recommended) {
    el('recommendedCredits').textContent = recommended.credits;
    el('recommendedPrice').textContent = `â‚¹${(recommended.price_paise / 100).toFixed(0)}`;
    el('recommendedReason').textContent = recommended.reason || '';
  }
  
  modal.classList.remove('hidden');
}

function closeInsufficientCreditsModal() {
  const modal = el('insufficientCreditsModal');
  if (modal) {
    modal.classList.add('hidden');
  }
}

function dismissLowBalanceWarning() {
  const warning = el('lowBalanceWarning');
  if (warning) {
    warning.classList.add('hidden');
  }
}

// Show login prompt
function showLoginPrompt() {
  const email = prompt('Enter your email to login:');
  const password = prompt('Enter your password:');
  
  if (email && password) {
    loginUser(email, password);
  }
}

// Login user
async function loginUser(email, password) {
  try {
    const response = await fetch('/api/auth/login', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ email, password })
    });
    
    if (response.ok) {
      const data = await response.json();
      setAuthToken(data.access_token);
      showToast('Login successful!', 'success');
      await loadUserBalance();
    } else {
      const error = await response.json();
      alert('Login failed: ' + error.detail);
    }
  } catch (error) {
    alert('Login error: ' + error.message);
  }
}

// Show toast notification
function showToast(message, type = 'info') {
  const toast = document.createElement('div');
  const colors = {
    success: 'bg-green-500',
    error: 'bg-red-500',
    warning: 'bg-yellow-500',
    info: 'bg-blue-500'
  };
  
  toast.className = `fixed bottom-4 right-4 ${colors[type]} text-white px-6 py-3 rounded-lg shadow-lg z-50 fade-in`;
  toast.textContent = message;
  document.body.appendChild(toast);
  
  setTimeout(() => toast.remove(), 4000);
}
    
    function escapeHtml(text) {
      if (!text) return '';
      return String(text).replace(/[&<>"']/g, (m) => ({ 
        '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;' 
      }[m]));
    }

    // ==========================================
    // MULTI-STEP FORM NAVIGATION
    // ==========================================
    let currentSection = 1;
    
    function showSection(sectionNum) {
      // Hide all sections
      for (let i = 1; i <= 3; i++) {
        el(`section${i}`).classList.add('hidden');
        el(`step${i}`).classList.remove('active');
        el(`step${i}`).classList.add('opacity-50');
        el(`step${i}`).querySelector('div').classList.remove('bg-gradient-to-r', 'from-indigo-500', 'to-purple-500');
        el(`step${i}`).querySelector('div').classList.add('bg-gray-300');
      }
      
      // Show target section
      el(`section${sectionNum}`).classList.remove('hidden');
      el(`section${sectionNum}`).classList.add('fade-in');
      
      // Update step indicator
      for (let i = 1; i <= sectionNum; i++) {
        el(`step${i}`).classList.remove('opacity-50');
        el(`step${i}`).classList.add('active');
        el(`step${i}`).querySelector('div').classList.remove('bg-gray-300');
        el(`step${i}`).querySelector('div').classList.add('bg-gradient-to-r', 'from-indigo-500', 'to-purple-500');
      }
      
      currentSection = sectionNum;
      
      // Update review summary if on section 3
      if (sectionNum === 3) {
        updateReviewSummary();
      }
      
      // Scroll to top
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function updateReviewSummary() {
      const platforms = Array.from(document.querySelectorAll('input[name="platforms"]:checked'))
        .map(i => i.value.charAt(0).toUpperCase() + i.value.slice(1))
        .join(', ');
      
      el('review_product').textContent = el('product_name').value || '-';
      el('review_budget').textContent = `$${el('daily_budget').value || '0'}/day Ã— ${el('campaign_days').value || '0'} days`;
      el('review_platforms').textContent = platforms || '-';
      el('review_days').textContent = `${el('campaign_days').value || '0'} days`;
    }
    
    function showSection(sectionNum) {
      // Hide all sections
      for (let i = 1; i <= 3; i++) {
        el(`section${i}`).classList.add('hidden');
        el(`step${i}`).classList.remove('active');
        el(`step${i}`).classList.add('opacity-50');
        el(`step${i}`).querySelector('div').classList.remove('bg-gradient-to-r', 'from-indigo-500', 'to-purple-500');
        el(`step${i}`).querySelector('div').classList.add('bg-gray-300');
      }
      
      // Show target section
      el(`section${sectionNum}`).classList.remove('hidden');
      el(`section${sectionNum}`).classList.add('fade-in');
      
      // Update step indicator
      for (let i = 1; i <= sectionNum; i++) {
        el(`step${i}`).classList.remove('opacity-50');
        el(`step${i}`).classList.add('active');
        el(`step${i}`).querySelector('div').classList.remove('bg-gray-300');
        el(`step${i}`).querySelector('div').classList.add('bg-gradient-to-r', 'from-indigo-500', 'to-purple-500');
      }
      
      currentSection = sectionNum;
      
      // Update review summary if on section 3
      if (sectionNum === 3) {
        updateReviewSummary();
      }
      
      // Scroll to top
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function updateReviewSummary() {
      const platforms = Array.from(document.querySelectorAll('input[name="platforms"]:checked'))
        .map(i => i.value.charAt(0).toUpperCase() + i.value.slice(1))
        .join(', ');
      
      el('review_product').textContent = el('product_name').value || '-';
      el('review_budget').textContent = `$${el('daily_budget').value || '0'}/day Ã— ${el('campaign_days').value || '0'} days`;
      el('review_platforms').textContent = platforms || '-';
      el('review_days').textContent = `${el('campaign_days').value || '0'} days`;
    }

    // ==========================================
    // DYNAMIC CALCULATIONS
    // ==========================================
    function updateTotalBudget() {
      const daily = parseFloat(el('daily_budget').value) || 0;
      const days = parseInt(el('campaign_days').value) || 0;
      const total = (daily * days).toFixed(2);
      el('totalBudget').textContent = `$${total}`;
    }
    
    // Make functions globally accessible for HTML onclick
    window.showSection = showSection;
    window.updateReviewSummary = updateReviewSummary;
    window.quickTopUp = () => window.location.href = '/pricing';
    window.dismissLowBalanceWarning = dismissLowBalanceWarning;
    window.proceedToQuickTopUp = () => { closeInsufficientCreditsModal(); window.location.href = '/pricing'; };
    window.closeInsufficientCreditsModal = closeInsufficientCreditsModal;
    window.downloadCampaign = downloadCampaign;
    window.viewDetails = viewDetails;
    window.copyToClipboard = copyToClipboard;
    window.openLoginModal = openLoginModal;
    window.openRegisterModal = openRegisterModal;
    window.closeLoginModal = closeLoginModal;
    window.closeRegisterModal = closeRegisterModal;
    window.switchToRegister = switchToRegister;
    window.switchToLogin = switchToLogin;
    window.toggleUserMenu = toggleUserMenu;
    window.logout = logout;
    window.viewDashboard = viewDashboard;
    window.viewMyCampaigns = viewMyCampaigns;
    window.viewSettings = viewSettings;
    
    el('daily_budget').addEventListener('input', updateTotalBudget);
    el('campaign_days').addEventListener('input', updateTotalBudget);

    // Character counter for description
    el('product_description').addEventListener('input', (e) => {
      const length = e.target.value.length;
      el('descLength').textContent = `${length} / 500`;
      if (length > 400) {
        el('descLength').classList.add('text-orange-500');
      } else {
        el('descLength').classList.remove('text-orange-500');
      }
    });

    // ==========================================
    // IMAGE UPLOAD HANDLING
    // ==========================================
    el('imageFile').addEventListener('change', async (e) => {
      const file = e.target.files[0];
      if (!file) return;
      
      // Show local preview
      const reader = new FileReader();
      reader.onload = (event) => {
        el('imagePreview').src = event.target.result;
        el('imagePrompt').classList.add('hidden');
        el('imagePreviewContainer').classList.remove('hidden');
      };
      reader.readAsDataURL(file);
    });

    // Drag and drop
    const dropZone = el('imageDropZone');
    
    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      dropZone.addEventListener(eventName, (e) => {
        e.preventDefault();
        e.stopPropagation();
      });
    });
    
    ['dragenter', 'dragover'].forEach(eventName => {
      dropZone.addEventListener(eventName, () => {
        dropZone.classList.add('border-indigo-500', 'bg-indigo-50');
      });
    });
    
    ['dragleave', 'drop'].forEach(eventName => {
      dropZone.addEventListener(eventName, () => {
        dropZone.classList.remove('border-indigo-500', 'bg-indigo-50');
      });
    });
    
    dropZone.addEventListener('drop', (e) => {
      const files = e.dataTransfer.files;
      if (files.length) {
        el('imageFile').files = files;
        el('imageFile').dispatchEvent(new Event('change'));
      }
    });

    // ==========================================
    // FORM SUBMISSION
    // ==========================================
    let generatedCampaignId = null;

 document.getElementById('campaignForm').addEventListener('submit', async (e) => {
  e.preventDefault();
  
  // Validate platforms
  const platforms = Array.from(document.querySelectorAll('input[name="platforms"]:checked')).map(i => i.value);
  if (platforms.length === 0) {
    el('platformsError').classList.remove('hidden');
    showSection(2);
    return;
  }
  el('platformsError').classList.add('hidden');
  
  showLoading();
  
  try {
    // Upload image first
    let imageInfo = null;
    const imageFile = el('imageFile').files[0];
    
    if (imageFile) {
      updateLoadingProgress('Uploading image...', 20);
      imageInfo = await uploadImage(imageFile);
    }
    
    // Prepare payload
    updateLoadingProgress('Preparing campaign data...', 40);
    
    const payload = {
      product_name: el('product_name').value.trim(),
      product_description: el('product_description').value.trim(),
      category: el('category').value.trim(),
      landing_page: el('landing_page').value.trim(),
      price_range: el('price_range').value,
      platforms,
      target_locations: ['US'],
      daily_budget_cents: parseFloat(el('daily_budget').value) * 100,
      total_budget_cents: parseFloat(el('daily_budget').value) * parseInt(el('campaign_days').value) * 100,
      duration_days: parseInt(el('campaign_days').value),
      cta_text: el('call_to_action').value.trim(),
      objective: el('objective').value,
      use_advanced_targeting: false,
      image_url: imageInfo ? imageInfo.url : null
    };
    
    // Check credits before generating
    console.log('ðŸ’³ Checking credits...');
    updateLoadingProgress('Checking credits...', 50);
    
    // Skip credit check if no token (for testing)
    const token = getAuthToken();
    if (!token) {
      console.log('âš ï¸ No token - skipping credit check for testing');
    } else {
      const creditCheck = await checkCampaignCredits(payload);
      
      if (!creditCheck.has_enough_credits) {
        console.log('âŒ Insufficient credits');
        hideLoading();
        showInsufficientCreditsModal(
          creditCheck.required_credits,
          creditCheck.current_balance,
          creditCheck.recommended_topup
        );
        return;
      }
      
      if (creditCheck.is_low_balance) {
        showToast(`âš ï¸ Low balance: ${creditCheck.current_balance} credits remaining`, 'warning');
      }
    }
    
    // Generate campaign
    updateLoadingProgress('Generating AI insights...', 70);
    
    const response = await fetch('/api/campaigns/create', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'Accept': 'application/json',
        ...(token && { 'Authorization': `Bearer ${token}` })
      },
      body: JSON.stringify(payload)
    });
    
    updateLoadingProgress('Finalizing campaign...', 90);
    
    const result = await response.json();
    
    hideLoading();
    
    if (response.status === 402) {
      console.log('âŒ 402 Insufficient credits');
      const details = result.detail || {};
      showInsufficientCreditsModal(
        details.required || creditCheck.required_credits,
        details.current || creditCheck.current_balance
      );
      return;
    }
    
    if (response.ok && result.success) {
      console.log('âœ… Campaign created successfully!');
      
      showToast(
        `ðŸŽ‰ Campaign created! ${result.credits_remaining} credits remaining`,
        'success'
      );
      
      await loadUserBalance();
      
      generatedCampaignId = result.campaign_id;
      
      displayResults({
        campaign_id: result.campaign_id,
        audience_insights: result.data?.audience_insights || {},
        campaign_strategy: result.data?.campaign_strategy || {},
        campaign_input: payload
      });
      
      enableExportUI(result.campaign_id);
      
    } else {
      showError(result.detail || result.message || 'Campaign creation failed');
    }
    
  } catch (error) {
    hideLoading();
    console.error('âŒ Campaign creation error:', error);
    showError(`Error: ${error.message}`);
  }
});

    // ==========================================
    // LOADING STATE MANAGEMENT
    // ==========================================
    function showLoading() {
      el('loading').classList.remove('hidden');
      el('loading').classList.add('flex');
    }
    
    function hideLoading() {
      el('loading').classList.add('hidden');
      el('loading').classList.remove('flex');
    }
    
    function updateLoadingProgress(step, progress) {
      el('loadingStep').textContent = step;
      el('loadingProgress').textContent = `${progress}%`;
      el('loadingBar').style.width = `${progress}%`;
    }

    // ==========================================
    // IMAGE UPLOAD
    // ==========================================
    async function uploadImage(file) {
      const formData = new FormData();
      formData.append('image', file);
      
      const response = await fetch('/api/upload-image', {
        method: 'POST',
        body: formData
      });
      
      if (!response.ok) {
        throw new Error('Image upload failed');
      }
      
      return await response.json();
    }

    // ==========================================
    // RESULTS DISPLAY
    // ==========================================
    function displayResults(campaign) {
      const resultsDiv = el('results');
      resultsDiv.classList.remove('hidden');
      resultsDiv.classList.add('fade-in');
      
      const audience = campaign.audience_insights || {};
      const strategy = campaign.campaign_strategy || {};
      
      const html = `
        <div class="glass-effect rounded-2xl shadow-2xl p-8 mb-8">
          <!-- Success Header -->
          <div class="text-center mb-8">
            <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-4">
              <i class="fas fa-check-circle text-green-600 text-4xl"></i>
            </div>
            <h2 class="text-3xl font-bold text-gray-800 mb-2">Campaign Generated Successfully!</h2>
            <p class="text-gray-600">Campaign ID: <span class="font-mono font-semibold">${escapeHtml(campaign.campaign_id)}</span></p>
            <div class="flex justify-center gap-3 mt-4">
              <button onclick="downloadCampaign('${campaign.campaign_id}')" class="px-4 py-2 bg-indigo-100 text-indigo-700 rounded-lg font-semibold hover:bg-indigo-200 transition-all">
                <i class="fas fa-download mr-2"></i>Download JSON
              </button>
              <button onclick="viewDetails('${campaign.campaign_id}')" class="px-4 py-2 bg-purple-100 text-purple-700 rounded-lg font-semibold hover:bg-purple-200 transition-all">
                <i class="fas fa-eye mr-2"></i>View Full Details
              </button>
            </div>
          </div>

          <!-- Key Metrics Grid -->
          <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
            <!-- Audience Card -->
            <div class="bg-gradient-to-br from-blue-50 to-indigo-50 rounded-xl p-6 border-l-4 border-blue-500">
<div class="flex items-center mb-4">
<i class="fas fa-users text-blue-600 text-2xl mr-3"></i>
<h3 class="font-bold text-lg text-gray-800">Target Audience</h3>
</div>
<div class="space-y-3">
<div>
<span class="text-sm text-gray-600">Age Range</span>
<p class="font-semibold text-gray-800">${escapeHtml(audience.age_min || 18)} - ${escapeHtml(audience.age_max || 65)} years</p>
</div>
<div>
<span class="text-sm text-gray-600">Top Interests</span>
<div class="flex flex-wrap gap-2 mt-2">
${(audience.interests || []).slice(0, 5).map(i => 
  `<span class="px-3 py-1 bg-blue-100 text-blue-700 rounded-full text-xs font-semibold">${escapeHtml(i)}</span>`
).join('')}
</div>
</div>
</div>
</div>
        <!-- Strategy Card -->
        <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-xl p-6 border-l-4 border-purple-500">
          <div class="flex items-center mb-4">
            <i class="fas fa-chart-line text-purple-600 text-2xl mr-3"></i>
            <h3 class="font-bold text-lg text-gray-800">Campaign Strategy</h3>
          </div>
          <div class="space-y-3">
            <div>
              <span class="text-sm text-gray-600">Primary Audience</span>
              <p class="font-semibold text-gray-800 text-sm">${escapeHtml(strategy.targeting_strategy?.primary_audience || 'Optimized targeting')}</p>
            </div>
            <div>
              <span class="text-sm text-gray-600">Key Messages</span>
              <ul class="text-xs text-gray-700 mt-2 space-y-1">
                ${(strategy.content_strategy?.key_messaging || []).slice(0, 2).map(m => 
                  `<li class="flex items-start"><i class="fas fa-check-circle text-purple-500 mr-2 mt-0.5"></i><span>${escapeHtml(m)}</span></li>`
                ).join('')}
              </ul>
            </div>
          </div>
        </div>

        <!-- Performance Card -->
        <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl p-6 border-l-4 border-green-500">
          <div class="flex items-center mb-4">
            <i class="fas fa-bolt text-green-600 text-2xl mr-3"></i>
            <h3 class="font-bold text-lg text-gray-800">Predictions</h3>
          </div>
          <div class="space-y-3">
            <div class="flex justify-between items-center">
              <span class="text-sm text-gray-600">Est. CTR</span>
              <span class="font-bold text-green-600">1.5-2.8%</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-sm text-gray-600">Est. CPC</span>
              <span class="font-bold text-green-600">$0.50-$1.20</span>
            </div>
            <div class="flex justify-between items-center">
              <span class="text-sm text-gray-600">Conv. Rate</span>
              <span class="font-bold text-green-600">2-5%</span>
            </div>
          </div>
        </div>
      </div>

      <!-- Campaign Assets -->
      <div class="space-y-6">
        <h3 class="text-xl font-bold text-gray-800 mb-4">
          <i class="fas fa-palette mr-2 text-indigo-600"></i>
          Generated Assets
        </h3>
        
        <!-- Ad Previews -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          ${['Facebook Feed', 'Instagram Story', 'Google Display'].map((platform, idx) => `
            <div class="bg-white rounded-xl shadow-lg overflow-hidden hover:shadow-xl transition-all">
              <div class="bg-gradient-to-r from-indigo-500 to-purple-500 text-white px-4 py-2 text-sm font-semibold">
                ${escapeHtml(platform)}
              </div>
              <div class="p-4">
                <div class="aspect-video bg-gray-100 rounded-lg mb-3 relative overflow-hidden">
                  ${campaign.campaign_input?.image_url ? 
                    `<img src="${escapeHtml(campaign.campaign_input.image_url)}" class="w-full h-full object-cover" />` : 
                    `<div class="flex items-center justify-center h-full text-gray-400">
                      <i class="fas fa-image text-4xl"></i>
                    </div>`
                  }
                  <div class="absolute bottom-3 left-3 right-3 bg-black bg-opacity-70 text-white px-3 py-2 rounded text-xs">
                    ${escapeHtml(campaign.campaign_input?.product_name || 'Product Name')}
                  </div>
                </div>
                <p class="text-xs text-gray-600 mb-3">${escapeHtml((strategy.content_strategy?.key_messaging || [''])[0].substring(0, 80))}...</p>
                <button class="w-full bg-indigo-600 text-white py-2 rounded-lg text-sm font-semibold hover:bg-indigo-700 transition-all">
                  ${escapeHtml(campaign.campaign_input?.call_to_action || 'Shop Now')}
                </button>
              </div>
            </div>
          `).join('')}
        </div>

        <!-- Hashtags & Captions -->
        <div class="bg-gradient-to-r from-indigo-50 to-purple-50 rounded-xl p-6">
          <h4 class="font-bold text-gray-800 mb-4 flex items-center">
            <i class="fas fa-hashtag mr-2 text-indigo-600"></i>
            Suggested Hashtags
          </h4>
          <div class="flex flex-wrap gap-2">
            ${generateHashtags(audience, strategy, 10).map(tag => 
              `<button onclick="copyToClipboard('${escapeHtml(tag)}')" class="px-3 py-1 bg-white border-2 border-indigo-200 text-indigo-700 rounded-full text-sm font-semibold hover:bg-indigo-100 transition-all">
                ${escapeHtml(tag)}
              </button>`
            ).join('')}
          </div>
        </div>
      </div>
    </div>
  `;
  
  resultsDiv.innerHTML = html;
  resultsDiv.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

// Update campaign cost preview when platforms change
function updateCostPreview() {
  const selectedCount = document.querySelectorAll('input[name="platforms"]:checked').length;
  const costEl = el('estimatedCost');
  const balanceAfterEl = el('balanceAfter');
  
  if (!costEl) return; // Element doesn't exist yet
  
  // Calculate cost based on platforms
  let cost = 10; // Base cost
  if (selectedCount > 3) {
    cost = 25;
  } else if (selectedCount > 1) {
    cost = 15;
  }
  
  costEl.textContent = cost;
  
  // Calculate balance after
  const currentBalance = parseInt(el('creditAmount')?.textContent) || 0;
  if (balanceAfterEl) {
    balanceAfterEl.textContent = Math.max(0, currentBalance - cost);
  }
}

// Attach to platform checkboxes
document.addEventListener('DOMContentLoaded', () => {
  const platformCheckboxes = document.querySelectorAll('input[name="platforms"]');
  if (platformCheckboxes.length > 0) {
    platformCheckboxes.forEach(checkbox => {
      checkbox.addEventListener('change', updateCostPreview);
    });
  }
});

// ==========================================
// EXPORT UI
// ==========================================
function enableExportUI(campaignId) {
  const exportDiv = el('facebookExport');
  exportDiv.classList.remove('hidden');
  exportDiv.classList.add('fade-in');
  
  exportDiv.innerHTML = `
    <div class="glass-effect rounded-2xl shadow-2xl p-8">
      <div class="text-center mb-6">
        <div class="w-16 h-16 bg-indigo-100 rounded-full flex items-center justify-center mx-auto mb-4">
          <i class="fas fa-rocket text-indigo-600 text-2xl"></i>
        </div>
        <h3 class="text-2xl font-bold text-gray-800 mb-2">Launch Your Campaign</h3>
        <p class="text-gray-600">Choose how you want to export your campaign</p>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
        <button id="previewBtn" class="p-6 bg-blue-50 rounded-xl hover:bg-blue-100 transition-all text-center group">
          <i class="fas fa-eye text-blue-600 text-3xl mb-3 group-hover:scale-110 transition-transform"></i>
          <h4 class="font-bold text-gray-800 mb-1">Preview Format</h4>
          <p class="text-xs text-gray-600">Review API payload structure</p>
        </button>

        <button id="dryRunBtn" class="p-6 bg-purple-50 rounded-xl hover:bg-purple-100 transition-all text-center group">
          <i class="fas fa-flask text-purple-600 text-3xl mb-3 group-hover:scale-110 transition-transform"></i>
          <h4 class="font-bold text-gray-800 mb-1">Test Export</h4>
          <p class="text-xs text-gray-600">Dry-run without creating ads</p>
        </button>

        <button id="realRunBtn" class="p-6 bg-green-50 rounded-xl hover:bg-green-100 transition-all text-center group">
          <i class="fas fa-play-circle text-green-600 text-3xl mb-3 group-hover:scale-110 transition-transform"></i>
          <h4 class="font-bold text-gray-800 mb-1">Create Real Ads</h4>
          <p class="text-xs text-gray-600">Launch live campaign (requires key)</p>
        </button>
      </div>

      <div id="exportMessage" class="hidden p-4 rounded-lg mb-4"></div>
    </div>
  `;

  // Event listeners
  el('previewBtn').addEventListener('click', () => previewCampaign(campaignId));
  el('dryRunBtn').addEventListener('click', () => dryRunExport(campaignId));
  el('realRunBtn').addEventListener('click', () => showConfirmModal());
  
  el('confirmModalBtn').addEventListener('click', () => realRunExport(campaignId));
  el('cancelModal').addEventListener('click', () => hideConfirmModal());
}

async function previewCampaign(campaignId) {
  setExportMessage('Loading preview...', 'info');
  try {
    const res = await fetch(`/api/export-formats/${campaignId}`);
    const data = await res.json();
    
    if (res.ok) {
      const w = window.open('', '_blank');
      w.document.write(`
        <html>
          <head>
            <title>Campaign Preview - ${campaignId}</title>
            <style>
              body { font-family: monospace; padding: 20px; background: #1e1e1e; color: #d4d4d4; }
              pre { background: #252526; padding: 20px; border-radius: 8px; overflow: auto; }
            </style>
          </head>
          <body>
            <h1>Campaign Export Preview</h1>
            <pre>${escapeHtml(JSON.stringify(data, null, 2))}</pre>
          </body>
        </html>
      `);
      setExportMessage('Preview opened in new tab', 'success');
    } else {
      setExportMessage('Preview failed: ' + (data.detail || data.message), 'error');
    }
  } catch (error) {
    setExportMessage('Preview error: ' + error.message, 'error');
  }
}

async function dryRunExport(campaignId) {
  setExportMessage('Running dry-run export...', 'info');
  try {
    const res = await fetch(`/api/export-campaign/${campaignId}`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ platforms: ['facebook'], create_real_ads: false })
    });
    
    const data = await res.json();
    
    if (res.ok && data.status === 'success') {
      setExportMessage('âœ“ Dry-run completed successfully! Check console for details.', 'success');
      console.log('Dry-run results:', data.export_results);
    } else {
      setExportMessage('Dry-run failed: ' + (data.detail || data.message), 'error');
    }
  } catch (error) {
    setExportMessage('Network error: ' + error.message, 'error');
  }
}

async function realRunExport(campaignId) {
  const adminKey = el('adminKeyInput').value.trim();
  
  if (!adminKey) {
    alert('Please enter your admin key');
    return;
  }
  
  hideConfirmModal();
  setExportMessage('Creating real ads...', 'info');
  
  try {
    const res = await fetch(`/api/export-campaign/${campaignId}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'X-API-KEY': adminKey
      },
      body: JSON.stringify({ platforms: ['facebook'], create_real_ads: true })
    });
    
    const data = await res.json();
    
    if (res.ok && data.status === 'success') {
      setExportMessage('âœ“ Real ads created successfully! Check your ad manager.', 'success');
      console.log('Real campaign results:', data.export_results);
    } else {
      setExportMessage('Campaign creation failed: ' + (data.detail || data.message), 'error');
    }
  } catch (error) {
    setExportMessage('Network error: ' + error.message, 'error');
  }
}

function showConfirmModal() {
  el('confirmModal').classList.remove('hidden');
  el('confirmModal').classList.add('flex');
}

function hideConfirmModal() {
  el('confirmModal').classList.add('hidden');
  el('confirmModal').classList.remove('flex');
  el('adminKeyInput').value = '';
}

function setExportMessage(message, type) {
  const msgDiv = el('exportMessage');
  msgDiv.classList.remove('hidden');
  
  const colors = {
    info: 'bg-blue-50 border-blue-500 text-blue-700',
    success: 'bg-green-50 border-green-500 text-green-700',
    error: 'bg-red-50 border-red-500 text-red-700'
  };
  
  const icons = {
    info: 'fa-info-circle',
    success: 'fa-check-circle',
    error: 'fa-exclamation-circle'
  };
  
  msgDiv.className = `p-4 rounded-lg border-l-4 ${colors[type]}`;
  msgDiv.innerHTML = `
    <div class="flex items-start">
      <i class="fas ${icons[type]} text-xl mr-3 mt-0.5"></i>
      <span>${escapeHtml(message)}</span>
    </div>
  `;
}

// ==========================================
// UTILITY FUNCTIONS
// ==========================================
function showError(message) {
  const resultsDiv = el('results');
  resultsDiv.classList.remove('hidden');
  resultsDiv.innerHTML = `
    <div class="glass-effect rounded-2xl shadow-2xl p-8 text-center">
      <div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-4">
        <i class="fas fa-exclamation-circle text-red-600 text-4xl"></i>
      </div>
      <h3 class="text-2xl font-bold text-gray-800 mb-2">Generation Failed</h3>
      <p class="text-red-600">${escapeHtml(message)}</p>
      <button onclick="location.reload()" class="mt-6 px-6 py-3 bg-indigo-600 text-white rounded-lg font-semibold hover:bg-indigo-700 transition-all">
        Try Again
      </button>
    </div>
  `;
  resultsDiv.scrollIntoView({ behavior: 'smooth' });
}

function generateHashtags(audience, strategy, maxTags = 8) {
  const interests = (audience.interests || []).slice(0, 10)
    .map(s => s.toLowerCase().replace(/[\s+\/,]+/g,'_').replace(/[^\w_]/g,''));
  const copy = (strategy.content_strategy?.key_messaging || []).join(' ');
  const keywords = (copy.match(/\b[a-zA-Z]{4,}\b/g) || []).slice(0, 12)
                   .map(w => w.toLowerCase().replace(/[^\w]/g,''));
  const combined = [...new Set([...interests, ...keywords])].filter(Boolean);
  const cleaned = combined.map(t => t.startsWith('#') ? t.replace('#','') : t).slice(0, maxTags);
  return cleaned.map(t => '#' + t);
}

function copyToClipboard(text) {
  navigator.clipboard.writeText(text).then(() => {
    // Show toast notification
    const toast = document.createElement('div');
    toast.className = 'fixed bottom-4 right-4 bg-green-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 fade-in';
    toast.innerHTML = `<i class="fas fa-check-circle mr-2"></i>Copied: ${escapeHtml(text)}`;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
  });
}

async function downloadCampaign(campaignId) {
  try {
    const response = await fetch(`/api/campaigns/${campaignId}/download`);
    if (!response.ok) throw new Error('Download failed');
    
    const blob = await response.blob();
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = `${campaignId}_campaign.json`;
    a.click();
    URL.revokeObjectURL(url);
  } catch (error) {
    alert('Download failed: ' + error.message);
  }
}

function viewDetails(campaignId) {
  window.open(`/api/campaigns/${campaignId}`, '_blank');
}

// ==========================================
// DRAFT SAVING
// ==========================================
el('saveDraftBtn').addEventListener('click', () => {
  const draft = {
    product_name: el('product_name').value,
    product_description: el('product_description').value,
    category: el('category').value,
    landing_page: el('landing_page').value,
    price_range: el('price_range').value,
    daily_budget: el('daily_budget').value,
    campaign_days: el('campaign_days').value,
    call_to_action: el('call_to_action').value,
    objective: el('objective').value,
    timestamp: new Date().toISOString()
  };
  
  localStorage.setItem('adtargetai_draft', JSON.stringify(draft));
  
  // Show toast
  const toast = document.createElement('div');
  toast.className = 'fixed bottom-4 right-4 bg-indigo-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 fade-in';
  toast.innerHTML = '<i class="fas fa-save mr-2"></i>Draft saved successfully';
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
});

// Load draft on page load
// Load draft on page load
window.addEventListener('load', () => {
  // Load user credit balance on page load
  loadUserBalance().then(balance => {
    if (balance) {
      console.log('âœ… Credit system ready. Balance:', balance.credits_balance);
    }
  });
  
  try {
    const draft = localStorage.getItem('adtargetai_draft');
    if (draft) {
      const data = JSON.parse(draft);
      Object.keys(data).forEach(key => {
        if (key !== 'timestamp' && el(key)) {
          el(key).value = data[key];
        }
      });
      
      // Show notification
      const toast = document.createElement('div');
      toast.className = 'fixed top-20 right-4 bg-blue-500 text-white px-6 py-3 rounded-lg shadow-lg z-50 fade-in';
      toast.innerHTML = `
        <i class="fas fa-info-circle mr-2"></i>
        Draft loaded from ${new Date(data.timestamp).toLocaleDateString()}
      `;
      document.body.appendChild(toast);
      setTimeout(() => toast.remove(), 5000);
    }
  } catch (e) {
    console.error('Failed to load draft:', e);
  }
});

// View campaigns button
el('viewCampaignsBtn').addEventListener('click', async () => {
  try {
    const res = await fetch('/api/campaigns');
    const data = await res.json();
    
    if (data.campaigns && data.campaigns.length > 0) {
      alert(`You have ${data.count} saved campaigns. Check console for details.`);
      console.log('Saved campaigns:', data.campaigns);
    } else {
      alert('No saved campaigns yet. Generate your first campaign!');
    }
  } catch (error) {
    alert('Failed to load campaigns: ' + error.message);
  }
});
});
  </script>
</body>
</html>